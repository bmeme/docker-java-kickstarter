#!/usr/bin/env bash

set -e
THIS_SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "${THIS_SCRIPT_DIR}/common/lib.sh"

mkdir -p "${BASE_PRJ_DIR}/.bmeme/log"

if ! test -f "${BASE_PRJ_DIR}/.env"; then
    echo "Please specify the vendor for your new project."
    echo "Typically this is your organization name, or the organization the projects belongs to."
    echo -n -e "${CY}Vendor:${CN} "
    read VENDOR

    echo ""
    echo "Please specify the name for your new project."
    echo -n -e "${CY}Project name:${CN} "
    read PROJECT

    echo ""
    echo -e "Configuring ${CG}env${CN} file..."
    sed "s/@@@PROJECT@@@/${PROJECT}/g;s/@@@VENDOR@@@/${VENDOR}/g" "${BASE_PRJ_DIR}/.env.dist" > "${BASE_PRJ_DIR}/.env"

    echo -e "Removing ${CG}.env.dist${CN} file..."
    rm -f "${BASE_PRJ_DIR}/.env.dist"

    source "${BASE_PRJ_DIR}/.env"
fi

if ! test -f "${BASE_PRJ_DIR}/.env"; then
    exit 1
fi

command_help() {

    echo ""
    echo "=============================================================================================="
    echo -e " ${CB}${TB}${COMPOSE_PROJECT_NAME}${CN} - ${CB}Help${CN} "
    echo "=============================================================================================="
    echo ""
    echo -en "${CY}"
    printf "%-25s" " help"
    echo -e "${CN} -- Show help on how to use this script"
    for i in $(ls "${BASE_PRJ_DIR}/.bmeme/build/commands"); do
        CMD_DESCR=$("${BASE_PRJ_DIR}/.bmeme/build/commands/$i" descr)
        echo -en "${CY}"
        printf "%-25s" " ${i%.*}"
        echo -e "${CN} -- ${CMD_DESCR}"
    done
    echo -en "${CY}"

    echo ""
    echo -e "DNS alias: ${CB}app.${PROJECT_NAME}.${PROJECT_VENDOR}.docker${CN}"
    echo ""
}

log_begin

if [ $# -eq 0 ]; then
    command_help
    exit 0
fi

for cmdLineArg in "$@"; do

    if [[ "$cmdLineArg" == "help" ]]; then
        command_help
    elif [[ -f "${BASE_PRJ_DIR}/.bmeme/build/commands/${cmdLineArg}.sh" ]]; then
        bash -c "${BASE_PRJ_DIR}/.bmeme/build/commands/${cmdLineArg}.sh run"
    else
        echo -e "Unrecognized command: ${CR}${cmdLineArg}${CN}"
        echo
        echo -e "Try: ${CY}${0} help${CN}"
        exit 1
    fi

done

log_end
exit 0
